# Интеграция по API

---

- [Введение](#about)
- [Основы](#base)
- [Базовые методы](#base-methods)
- [Описание API](#about-api)
- [Мерчант API](#merchant-api)
- [H2H API](#h2h-api)
- [Общее дополнение к описанию API](#addition)
- [Уведомление об изменении статуса платежа](#callback)

<a name="about"></a>
## Введение
Ниже представлено описание того как работает API, с помощью которого вы сможете сделать интеграцию с вашим сайтом.

<a name="base"></a>
## Основы
1. Все запросы к API должны содержать обязательные заголовоки
- **Accept: application/json** - нужно чтобы сервер знал в каком формате вернуть ответ.
- **Access-Token: token** - нужно для авторизации. Находится в разделе "Интеграция".
2. Форматы ответов сервера:

### Формат успешных ответов
```json
{
    "success": true, 
    "data": [
        //...
    ]
}
```
- Где **data** - это тело ответа.
- **HTTP** код для успешных ответов всегда - 2**. Чаще всего просто 200.

### Формат ошибки валидации
```json
{
    "message": "Общее описание ошибки",
    "errors": {
        "название параметра": [
            "Описание ошибки поля"
        ],
        //...
    }
}
```
- - **HTTP** код 422.

### Формат ошибок бизнес логики
```json
{
    "success": false,
    "message": "Описание ошибки"
}
```
- - **HTTP** код 400.

### Формат серверных ошибок
```json
{
    "message": "Internal Server Error"
}
```
- - **HTTP** код 500.


<a name="base-methods"></a>
## Базовые методы
### GET /api/currencies
- Возвращает список всех доступных валют для p2p процессинга.
- Ответ сервера:
```json
{
        "success": true,
        "data": [
            {
                "currency": "rub",
                "precision": 2,
                "symbol": "₽",
                "name": "Российский рубль"
            }
            //...
        ]
}
```
### GET /api/payment-gateways
- Возвращает список всех доступных методов для p2p процессинга.
- Ответ сервера:
```json
{
        "success": true,
        "data": [
            {
                "name": "Сбербанк",
                "code": "sberbank_rub",
                "currency": "rub",
                "min_limit": "1000", // минимальная сумма для процессинга. Целое число в валюте метода. 1000 = 1000 рублей.
                "max_limit": "100000", // максимальная сумма для процессинга. Целое число в валюте метода. 1000 = 1000 рублей.
                "reservation_time": 1, //время на которое выдается реквизит для оплаты. В минутах.
                "detail_types": [ //типы реквизитов которые доступны для данного метода.
                    "card", //номер карты
                    "phone", //номер телефона
                    "account_number" //номер счета
                ],
                "service_commission_rate": 9, //полная коммиссия сервиса в %
                "trader_commission_rate": 2.5, //наценка трейдера на базовый курс
                "base_conversion_price": "98.32", //базовый курс
                "conversion_price": "100.77" //цена конвертации валюты в USDT
            }
            //..
        ]
}
```

<a name="about-api"></a>
## Описание API

- В системе есть два вида API - Мerchant и H2H
- **Merchant API** - нужен для интеграции магазинов, и разных сервисов на которых вы захотите подключить оплату.
- **H2H API** - больше подходит для интеграции с платежными сервисами. С помощью данного API, владельцы платежных сервисов, могут добавить новый платежный шлюз p2p платежей.
- Основное различие в том, что H2H API предоставляет более широкий и гибкий функционал для интеграции чем Merchant API, а также дает больше методов для управления сделками и спорами. В свою очередь Merchant API более простой, вы можете создать сделку, а ее управлением и обработкой займется наш сервис.
- Важное замечание - для сделок созданный через H2H API не предоставляется платежная ссылка.

<a name="merchant-api"></a>
## Мерчант API

### POST /api/merchant/order
- Создает платеж/сделку.
- Описание параметров запроса:
  - **external_id** - id сделки на стороне внешнего сервиса. Должен быть уникальным для мерчанта.
  - **amount** - сумма сделки. Только целое число. 100 = 100 rub (или другая валюта).
  - **payment_gateway** - код платежного метода. Не обязательный параметр если указана валюта (currency).
  - **currency** - код валюты. Не обязательный параметр если указан метод (payment_gateway).
  - **payment_detail_type** - тип реквизита с которым будет создана сделка (card, phone, account_number). Не обязательный параметр.
  - **merchant_id** - uuid мерчанта. Можно найти на странице мерчанта в разделе настройки. 
  - **callback_url** - ссылка на которую будет направлена информация об изменении статуса сделки. Не обязательный параметр.
  - **success_url** - ссылка на которую перенаправлен пользователь в случае успешной оплаты. Не обязательный параметр.
  - **fail_url** - ссылка на которую будет перенаправлен пользователь в случае если оплата не была произведена. Не обязательный параметр.

- Ответ сервера:
```json
{
        "success": true,
        "data": {
            "order_id": "4b3a163b...", //uuid сделки внутри системы.
            "external_id": "...", 
            "merchant_id": "...",
            "amount": "1000",
            "currency": "rub",
            "status": "pending", // статус сделки. success, fail, pending.
            "callback_url": null,
            "success_url": null,
            "fail_url": null, 
            "payment_gateway": "sberbank_rub", // код платежного метода
            "payment_gateway_name": "Сбербанк", // название платежного метода
            "method": null, // код платежного метода если payment_gateway = СБП
            "method_name": null, // название платежного метода если payment_gateway = СБП 
            "finished_at": null, // время закрытия сделки
            "expires_at": 1731375451, // время когда сделка будет автоматически закрыта.
            "created_at": 1731375391, // время создания сделки.
            "payment_link": "http://example.com/payment/4b3a163b..." // ссылка на оплату.
        }
}
```

### GET /api/merchant/order/{order_id}
- Возвращает информацию о сделке. Возвращает такой же объект как при создании сделки.
- **order_id** - uuid сделки.

<a name="h2h-api"></a>
## H2H API

### POST /api/h2h/order
- Создает платеж/сделку.
- В отличии от Merchant API не содержит параметров success_url и fail_url.
- И возвращает больше данных для создания собственной страницы оплаты.
- Ответ сервера:
```json
{
        "success": true,
        "data": {
            "order_id": "3db07a16...", //uuid сделки внутри системы.
            "external_id": "...",
            "merchant_id": "...",
            "base_amount": "1000", // сумма присланная при создании сделки.
            "amount": "1090", // сумма для к полате, содержит в себе комиссию клиента.
            "profit": "9.94", //amount в usdt
            "merchant_profit": "9.05", // доход мерчанта в usdt
            "service_profit": "0.89", // комиссия сервиса в usdt
            "currency": "rub",
            "profit_currency": "usdt",
            "conversion_price_currency": "rub",
            "base_conversion_price": "98.32", //сумма конвертации RUB в USDT.
            "conversion_price": "100.77", //сумма конвертации RUB в USDT с комиссией трейдера.
            "trader_commission_rate": 2.5, //комиссия трейдера в %
            "service_commission_rate_total": 9, //полная комиссия сервиса в %
            "service_commission_rate_merchant": 9, //часть комисси сервиса которую платит мерчант
            "service_commission_rate_client": 0, //часть комисси сервиса которую платит клиент
            "status": "pending",
            "callback_url": "...",
            "payment_gateway": "sberbank_rub", // код платежного метода
            "payment_gateway_name": "Сбербанк", // название платежного метода
            "method": null, // код платежного метода если payment_gateway = СБП
            "method_name": null, // название платежного метода если payment_gateway = СБП 
            "payment_detail": {
                "detail": "1000200030004000", // реквизит для перевода
                "detail_type": "card", // тип реквизита
                "initials": "Пол Атрейдес" // владелец реквизита
            },
            "merchant": {
                "name": "...",
                "description": "..."
            },
            "finished_at": null, // время закрытия сделки
            "expires_at": 1731375451, // время когда сделка будет автоматически закрыта.
            "created_at": 1731375391, // время создания сделки.
            "current_server_time": 1731655862
        }
}
```

### PATCH /api/h2h/order/{order_id}/cancel
- Досрочно закрывает сделку если она находится в статусе pending и не имеет открытых споров.
- **order_id** - uuid сделки.

### GET /api/h2h/order/{order_id}
- Возвращает информацию о сделке. Возвращает такой же объект как при создании сделки.
- **order_id** - uuid сделки.

### POST /api/h2h/order/{order_id}/dispute
- Создает спор по сделке которая была завершена со статусом fail
- **order_id** - uuid сделки.
- Ответ сервера:
```json
{
    "success": true,
    "data": {
        "order_id": "3db07a16...",
        "status": "pending",
        "cancel_reason": null // причина отказа
    }
}
```

### GET /api/h2h/order/{order_id}/dispute
- Возвращает информацию о споре по текущей сделке.
- **order_id** - uuid сделки.

<a name="addition"></a>
## Общее дополнение к описанию API
- Не для всех вариантов параметров может быть доступный реквизит. Поэтому сервер вернет сообщение что реквизит не найден.
- Параметр payment_gateway - создаст сделку только для этого платежного метода. В то время как параметр currency создаст сделку в рамках это валюты, но для любого платежного метода.
- Параметры payment_gateway и currency взаимоисключающие и не могут быть использованы одновременно.
- Если сумма сделки выходит за лимиты указанного платежного метода или всех доступных методов указанных в **/api/payment-gateways** то сервер вернет ошибку что подходящий платежный метод не найден.
- Параметр callback_url также есть в настройках мерчанта, но если параметр передать в запросе к API, то он будет старше. Т.е. уведомление будет отправлено по url указанного в запросе, но не в админке.
- Параметр payment_detail_type нужно использовать аккуратно. И чаще всего в связке с параметров currency. Так как не для всех платежных методов если реквизиты всех типов.
- Cумма сделки может изменить после ее создания. Вернется в параметре amount. Так как существует наценка в виде комиссии клиента. Указывается в настройках мерчанта. Например при комиссии клиента в 4%, сумма 1000 будет изменена на 1040.
- Сделкой можно управлять только через соответствующий API

## Уведомление об изменении статуса платежа
- По ссылке указанной в настройках мерчанта, или переданной в параметре callback_url при создании сделки, будет отправлено уведомление если сделка изменит свой статус.
- Доступные статусы: success, fail, pending
- Уведомление содержит данные соответствующие данным которы возвращает метод **GET /api/h2h/order/{order_id}** или **GET /api/merchant/order/{order_id}** в зависимости от используемого API.
