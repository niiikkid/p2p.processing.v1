# Интеграция по API

---

- [О проекте](#about)
- [Основы](#base)
- [Доступные методы](#methods)

<a name="about"></a>
## Что это?
Ниже представлено описание того как работает API, и как сделать интеграцию с вашим сервисом.

<a name="base"></a>
## Основы
1. Все запросы к API должны содержать обязательные заголовоки
- **Accept: application/json** - нужно чтобы сервер знал в каком формате вернуть ответ.
- **Access-Token: token** - нужно для авторизации. Находится в разделе "Интеграция".
2. Форматы ответов сервера:

### Формат успешных ответов
```json
{
    "success": true, 
    "data": [
        //...
    ]
}
```
- Где **data** - это тело ответа.
- **HTTP** код для успешных ответов всегда - 2**. Чаще всего просто 200.

### Формат ошибки валидации
```json
{
    "message": "Общее описание ошибки",
    "errors": {
        "название параметра": [
            "Описание ошибки поля"
        ],
        //...
    }
}
```
- - **HTTP** код 422.

### Формат ошибок бизнес логики
```json
{
    "success": false,
    "message": "Описание ошибки"
}
```
- - **HTTP** код 400.

### Формат серверных ошибок
```json
{
    "message": "Internal Server Error"
}
```
- - **HTTP** код 500.


<a name="methods"></a>
## Доступные методы
### POST /api/order
Метод для создания сделок.

### GET /api/currencies
- Возвращает список всех доступных валют для процессинга.
- Ответ сервера:
```json
{
        "success": true,
        "data": [
            "rub"
            //..
        ]
}
```
### GET /api/payment-gateways
- Возвращает список всех доступных методов для процессинга.
- Ответ сервера:
```json
{
        "success": true,
        "data": [
            {
                "name": "Сбербанк", // название метода на русском.
                "code": "sberbank_rub", // уникальный код метода.
                "currency": "rub", // валюта метода.
                "min_limit": "1000", // минимальная сумма для процессинга. Целое число в валюте метода. 1000 = 1000 рублей.
                "max_limit": "100000", // максимальная сумма для процессинга. Целое число в валюте метода. 1000 = 1000 рублей.
                "service_commission_rate": 9 // коммиссия сервиса в %.
            }
            //..
        ]
}
```

### POST /api/order
- Создает платеж/сделку.
- Описание параметров запроса:
  - **external_id** - id сделки на стороне внешнего сервиса. Должен быть уникальным для мерчанта.
  - **amount** - сумма сделки. Только целое число. 100 = 100 rub (или другая валюта).
  - **payment_gateway** - код платежного метода. Не обязательный параметр если указана валюта (currency).
  - **currency** - код валюты. Не обязательный параметр если указан метод (payment_gateway).
  - **payment_detail_type** - тип реквизита с которым будет создана сделка (card, phone, account_number). Не обязательный параметр.
  - **merchant_id** - uuid мерчанта. Можно найти на странице мерчанта в разделе настройки. 
  - **callback_url** - ссылка на которую будет направлена информация об изменении статуса сделки. Не обязательный параметр.
  - **success_url** - ссылка на которую перенаправлен пользователь в случае успешной оплаты. Не обязательный параметр.
  - **fail_url** - ссылка на которую будет перенаправлен пользователь в случае если оплата не была произведена. Не обязательный параметр.

- Ответ сервера:
```json
{
        "success": true,
        "data": {
            "order_id": "4b3a163b...", //uuid сделки внутри системы.
            "external_id": "...", 
            "merchant_id": "...",
            "amount": "1000",
            "currency": "rub",
            "status": "pending", // статус сделки. success, fail, pending.
            "callback_url": null,
            "success_url": null,
            "fail_url": null, 
            "payment_gateway": "sberbank_rub", // код платежного метода
            "payment_gateway_name": "Сбербанк", // название платежного метода
            "method": null, // код платежного метода если payment_gateway = СБП
            "method_name": null, // название платежного метода если payment_gateway = СБП 
            "finished_at": null, // время закрытия сделки
            "expires_at": 1731375451, // время когда сделка будет автоматически закрыта.
            "created_at": 1731375391, // время создания сделки.
            "payment_link": "http://example.com/payment/4b3a163b..." // ссылка на оплату.
        }
}
```
- Описание некоторой не очевидной логики:
    - Не для всех вариантов параметров может быть доступный реквизит. Поэтому сервер вернет сообщение что реквизит не найден.
    - Параметр payment_gateway - создаст сделку только для этого платежного метода. В то время как параметр currency создаст сделку в рамках это валюты, но для любого платежного метода.
    - Параметры payment_gateway и currency взаимоисключающие и не могут быть использованы одновременно.
    - Если сумма сделки выходит за лимиты указанного платежного метода или всех доступных методов указанных в **/api/payment-gateways** то сервер вернет ошибку что подходящий платежный метод не найден.
    - Параметр callback_url также есть в настройках мерчанта, но если параметр передать в запросе к API, то он будет старше. Т.е. уведомление будет отправлено по url указанного в запросе, но не в админке.
    - Параметр payment_detail_type нужно использовать аккуратно. И чаще всего в связке с параметров currency. Так как не для всех платежных методов если реквизиты всех типов.
    - Cумма сделки может изменить после ее создания. Вернется в параметре amount. Так как существует наценка в виде комиссии клиента. Указывается в настройках мерчанта. Например при комиссии клиента в 4%, сумма 1000 будет изменена на 1040.

### PATCH /api/order/{order_id}/cancel
- Досрочно закрывает сделку если она находится в статусе pending и не имеет открытых споров.
- **order_id** - uuid сделки.

### GET /api/order/{order_id}
- Возвращает информацию о сделке. Возвращает такой же объект как при создании сделки.
- **order_id** - uuid сделки.

